{% extends 'base.html.twig' %}
{% block title %}Potager{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('app') }}
    {{ encore_entry_script_tags('style') }}
    {{ encore_entry_script_tags('print') }}
{% endblock %}

{% block body %}
<div class="wrapper" style="margin-top:1rem;">

    {# ===== CARTE UTILISATEUR ===== #}
    <div class="gg-details" style="margin-bottom:0.75rem;">
        <div class="gg-details-content">
            <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">

                {# Avatar + pseudo #}
                <div style="text-align:center; min-width:90px;">
                    {% if user.avatar %}
                        <img src="{{ vich_uploader_asset(user.avatar) }}"
                             alt="Avatar"
                             style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--vertLightColor);">
                    {% endif %}
                    <div style="font-weight:700; color:var(--roseDarkColor); margin-top:0.3rem; font-size:0.9rem;">{{ user.nickname }}</div>
                </div>

                {# Stats apercu #}
                <div style="flex:1; border-left:1px solid #ebebeb; padding-left:1rem;">
                    {{ include('garden/apercu.html.twig', {'r_byuser': r_byuser, 'fluxAchats': fluxAchats, 'calories': calories, 'user': user}) }}
                </div>
            </div>

            {# Infos jardin #}
            {% if garden.region is not null or garden.surface is not null %}
            <hr class="gg-divider" style="margin-top:1rem;"/>
            <div style="font-size:0.82rem; color:#666; display:flex; flex-direction:column; gap:0.3rem;">
                {% if garden.region is not null %}
                    <span>ğŸ—ºï¸ {{ garden.region.countryCode }} â€” {{ garden.region.name }}</span>
                {% endif %}
                {% if garden.surface is not null %}
                    <span>ğŸŒ± <strong>Surface :</strong> {{ garden.surface.nom }} ({{ garden.surface.metre }}) &nbsp;|&nbsp; ğŸ¯ <strong>Objectif :</strong> {{ garden.surface.objectif }} kg</span>
                {% endif %}
                {% if garden.sable is not null %}
                    <span>ğŸª¨ <strong>Terre :</strong> Sable {{ garden.sable }}% Â· Argile {{ garden.argile }}% Â· Calcaire {{ garden.calcaire }}% Â· Limon {{ garden.limon }}%</span>
                {% endif %}
                {% if garden.serre is not null %}
                    <span>ğŸ¡ <strong>Serre :</strong> {{ garden.serre }} mÂ²</span>
                {% endif %}
                {% if garden.cuve is not null %}
                    <span>ğŸ’§ <strong>Cuves :</strong> {{ garden.cuve }} L</span>
                {% endif %}
                {% if garden.minpluvio is not null %}
                    <span>ğŸŒ§ï¸ <strong>PluviomÃ©trie :</strong> {{ garden.minpluvio }} â€“ {{ garden.maxpluvio }}</span>
                {% endif %}
                {% if garden.moyenneprod is not null %}
                    <span>ğŸ“¦ <strong>Production moyenne :</strong> {{ garden.moyenneprod }} kg/an</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {# ===== BOUTON SUIVRE ===== #}
    {% if app.user != user %}
    <div class="gg-details" style="margin-bottom:0.75rem;">
        <div class="gg-details-content" style="text-align:center;">
            <a href="{{ path('ami', {'id': user.id}) }}"
               class="gg-action-btn {{ amis == 1 ? 'btn-note' : 'btn-plant' }}"
               style="display:inline-flex; width:auto;">
                <span class="btn-icon">{{ amis == 1 ? 'â­' : 'ğŸŒ±' }}</span>
                <span class="btn-label">{{ amis == 1 ? 'Jardinier suivi' : 'Suivre ce jardinier' }}</span>
            </a>
        </div>
    </div>
    {% endif %}

{# ===== SELECTION ANNEE ===== #}
    {% include 'garden/year_selector.html.twig' with {
    years_with_data: available_years,
    selected_year: selected_year
    } %}

    {# ===== SYNTHESE & GRAPHIQUES ===== #}
    <div id="content">
        {{ include('garden/synthese.html.twig', {'p_byuser': p_byuser, 'r_byuser': r_byuser, 'user': user}) }}
        {{ include('garden/graphs.html.twig', {'p_byuser': p_byuser, 'r_byuser': r_byuser, 'chart': chart, 'chart_don_r': chart_don_r, 'user': user}) }}
    </div>

    {# ===== AMIS ===== #}
    {% set classe = "gg-details" %}
    {{ include('garden/amis.html.twig', {'amis': amis, 'user': user, 'classe': classe}) }}

    {# ===== PARTAGER & MÃ‰TÃ‰O ===== #}
    <div class="gg-details" style="margin-bottom:0.75rem;">
        <div class="gg-details-content" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem;">
            <a href="{{ 'whatsapp://send?text=http://www.GreenGarden.fr/bou/' ~ user.nickname }}"
               class="gg-action-btn btn-plant" style="display:inline-flex; width:auto;">
                <span class="btn-icon">ğŸ“¤</span>
                <span class="btn-label">Partager le jardin</span>
            </a>
            <a target="_blank" href="https://meteofrance.com/previsions-meteo-france/"
               class="gg-action-btn btn-note" style="display:inline-flex; width:auto;">
                <span class="btn-icon">ğŸŒ¤ï¸</span>
                <span class="btn-label">MÃ©tÃ©o locale</span>
            </a>
        </div>
    </div>

</div>
{% endblock %}
