{% extends 'base.html.twig' %}
{% block title %}Potager{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('app') }}
    {{ encore_entry_script_tags('style') }}
    {{ encore_entry_script_tags('print') }}
{% endblock %}

{% block body %}
<div class="wrapper" style="margin-top:1rem;">

    {# ===== CARTE UTILISATEUR ===== #}
    <div class="gg-details" style="margin-bottom:0.75rem;">
        <div class="gg-details-content">
            <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">

                {# Avatar + pseudo #}
                <div style="text-align:center; min-width:90px;">
                    {% if user.avatar %}
                        <img src="{{ vich_uploader_asset(user.avatar) }}"
                             alt="Avatar"
                             style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--vertLightColor);">
                    {% endif %}
                    <div style="font-weight:700; color:var(--roseDarkColor); margin-top:0.3rem; font-size:0.9rem;">{{ user.nickname }}</div>
                </div>

                {# Stats apercu #}
                <div style="flex:1; border-left:1px solid #ebebeb; padding-left:1rem;">
                    {{ include('garden/apercu.html.twig', {'r_byuser': r_byuser, 'fluxAchats': fluxAchats, 'calories': calories, 'user': user}) }}
                </div>
            </div>

        {% if garden is not null %}
            {# Infos jardin #}
            <hr class="gg-divider" style="margin-top:1rem;"/>
            <div style="font-size:0.82rem; color:#666; display:flex; flex-direction:column; gap:0.3rem;">
                {% if garden.region is not null %}
                    <span>ğŸ—ºï¸ {{ garden.region.countryCode }} â€” {{ garden.region.name }}</span>
                {% endif %}
                {% if garden.surface is not null %}
                    <span>ğŸŒ± <strong>Surface :</strong> {{ garden.surface.nom }} ({{ garden.surface.metre }}) &nbsp;|&nbsp; ğŸ¯ <strong>Objectif :</strong> {{ garden.surface.objectif }} kg</span>
                {% endif %}
                {% if garden.sable is not null %}
                    <span>ğŸª¨ <strong>Terre :</strong> Sable {{ garden.sable }}% Â· Argile {{ garden.argile }}% Â· Calcaire {{ garden.calcaire }}% Â· Limon {{ garden.limon }}%</span>
                {% endif %}
                {% if garden.serre is not null %}
                    <span>ğŸ¡ <strong>Serre :</strong> {{ garden.serre }} mÂ²</span>
                {% endif %}
                {% if garden.cuve is not null %}
                    <span>ğŸ’§ <strong>Cuves :</strong> {{ garden.cuve }} L</span>
                {% endif %}
                {% if garden.minpluvio is not null %}
                    <span>ğŸŒ§ï¸ <strong>PluviomÃ©trie :</strong> {{ garden.minpluvio }} â€“ {{ garden.maxpluvio }}</span>
                {% endif %}
                {% if garden.moyenneprod is not null %}
                    <span>ğŸ“¦ <strong>Production moyenne :</strong> {{ garden.moyenneprod }} kg/an</span>
                {% endif %}
            </div>
                {# Lien Ã©dition uniquement si c'est MON jardin #}
                {% if app.user == user %}
                    <a href="{{ path('app_garden_edit') }}" class="gg-action-btn btn-plant"
                    style="display:inline-flex; width:auto; padding:0.4rem 1rem; font-size:0.82rem; margin-top:0.6rem; box-shadow:none;">
                        <span class="btn-icon" style="font-size:1rem;">âœï¸</span>
                        <span class="btn-label">Configurer mon jardin</span>
                    </a>
                {% endif %}
        {% else %}
            {% if app.user == user %}
                    <a href="{{ path('app_garden_edit') }}" class="gg-action-btn btn-plant"
                        style="display:inline-flex; width:auto; padding:0.4rem 1rem; font-size:0.82rem; margin-top:0.6rem; box-shadow:none;">
                        <span class="btn-icon" style="font-size:1rem;">âš™ï¸</span>
                        <span class="btn-label">Configurer mon jardin</span>
                    </a>
            {% else %}
                <span style="font-size:0.85rem; color:#aaa;">ğŸŒ± Ce jardinier n'a pas encore configurÃ© son jardin.</span>
            {% endif %}
        {% endif %}
        </div>
    </div>

    {# ===== BOUTON SUIVRE ===== #}

{% set est_suivi = false %}
{% for ami in amis %}
    {% if ami.userFollowed == user %}
        {% set est_suivi = true %}
    {% endif %}
{% endfor %}

{% if app.user != user %}
<div class="gg-details" style="margin-bottom:0.75rem;">
    <div class="gg-details-content" style="text-align:center;">
        <form method="post" action="{{ path('ami', {'id': user.id}) }}" style="margin:0;">
            <input type="hidden" name="_token" value="{{ csrf_token('ami') }}">
            <button type="submit" class="gg-action-btn {{ est_suivi ? 'btn-note' : 'btn-plant' }}"
                    style="display:inline-flex; width:auto; border:none; cursor:pointer; font-family:inherit;">
                <span class="btn-icon">{{ est_suivi ? 'â­' : 'ğŸŒ±' }}</span>
                <span class="btn-label">{{ est_suivi ? 'Jardinier suivi' : 'Suivre ce jardinier' }}</span>
            </button>
        </form>
    </div>
</div>
{% endif %}


{# ===== SELECTION ANNEE ===== #}
<div style="margin-bottom:0.75rem;">
    {% include 'garden/year_selector.html.twig' with {
    years_with_data: available_years,
    selected_year: selected_year
    } %}
</div>

    {# ===== SYNTHESE & GRAPHIQUES ===== #}
    <div id="content">
        {{ include('garden/synthese.html.twig', {'p_byuser': p_byuser, 'r_byuser': r_byuser, 'user': user}) }}
        {{ include('garden/graphs.html.twig', {'p_byuser': p_byuser, 'r_byuser': r_byuser, 'chart': chart, 'chart_don_r': chart_don_r, 'user': user}) }}
    </div>

    {# ===== AMIS ===== #}
{% if app.user == user %}
    {% set classe = "gg-details" %}
    {{ include('garden/amis.html.twig', {'amis': amis, 'user': user, 'classe': classe}) }}
{% endif %}

    {# ===== PARTAGER & MÃ‰TÃ‰O ===== #}
                    {# ===== COPIER LE LIEN PUBLIC ===== #}
                    {% set publicUrl = app.request.schemeAndHttpHost ~ '/bou/' ~ user.nickname %}

                    <button type="button"
                            class="gg-action-btn btn-plant"
                            style="display:inline-flex; width:auto;"
                            onclick="copyGardenLink()">
                        <span class="btn-icon">ğŸ”—</span>
                        <span class="btn-label">Copier le lien du jardin</span>
                    </button>

                    <script>
                    function copyGardenLink() {
                        const url = "{{ publicUrl }}";

                        navigator.clipboard.writeText(url).then(function() {
                            alert("Lien copiÃ© !");
                        }).catch(function() {
                            alert("Impossible de copier le lien.");
                        });
                    }
                    </script>

        {# ===== MÃ‰TÃ‰O PERSONNALISÃ‰E ===== #}
        {% if garden is not null and garden.region is not empty %}
            <a target="_blank" href="{{ garden.region.meteolink }}"
               class="gg-action-btn btn-note"
               style="display:inline-flex; width:auto; opacity:0.8;">
                <span class="btn-icon">ğŸŒ¤ï¸</span>
                <span class="btn-label">MÃ©tÃ©o {{ garden.region.name }}</span>
            </a>
        {% else %}
            <a href="{{ path('app_garden_edit') }}"
               class="gg-action-btn btn-note"
               style="display:inline-flex; width:auto;">
                <span class="btn-icon">ğŸŒ¤ï¸</span>
                <span class="btn-label">Choisir ma rÃ©gion mÃ©tÃ©o</span>
            </a>
        {% endif %}
        </div>
    </div>

</div>
{% endblock %}
